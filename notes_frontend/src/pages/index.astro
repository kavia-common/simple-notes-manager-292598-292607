---
import Layout from '../layouts/Layout.astro';

/*
PUBLIC_INTERFACE
This page provides a full-featured localStorage-backed notes experience.
- Responsive split layout (sidebar list + editor on desktop, stacked on mobile)
- Create, edit, delete notes with confirmation
- Search/filter by title/body
- Autosave title and body with debouncing
- Sort by last updated desc
- Persistent storage via localStorage under key 'notes.v1'
- Accessible controls and smooth transitions
- Ocean Professional theme using CSS variables in Layout

No backend required. If PUBLIC_* env vars exist, they are not required here.
*/
---

<Layout>
  <main class="app" aria-label="Notes application">
    <header class="topbar" role="banner">
      <div class="brand">
        <span class="logo" aria-hidden="true">✦</span>
        <h1 class="title">Simple Notes</h1>
      </div>
      <div class="actions">
        <button id="new-note" class="btn primary" type="button" aria-label="Create new note">
          New Note
        </button>
      </div>
    </header>

    <section class="content">
      <aside class="sidebar" aria-label="Notes list">
        <div class="sidebar-controls">
          <div class="search-wrap">
            <input
              id="search"
              type="search"
              placeholder="Search notes…"
              aria-label="Search notes"
              autocomplete="off"
            />
            <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
              <path fill="currentColor" d="M10 4a6 6 0 1 1 3.87 10.6l4.76 4.77-1.41 1.41-4.77-4.76A6 6 0 0 1 10 4m0 2a4 4 0 1 0 0 8a4 4 0 0 0 0-8z"/>
            </svg>
          </div>
          <label class="sort">
            <span>Sort</span>
            <select id="sort" aria-label="Sort notes">
              <option value="updated_desc" selected>Last updated</option>
              <option value="title_asc">Title (A–Z)</option>
            </select>
          </label>
        </div>
        <ul id="notes-list" class="notes" role="list" aria-live="polite" aria-busy="false"></ul>
        <div id="empty-list" class="empty hidden" role="note">
          <p>No notes yet.</p>
          <button id="empty-create" class="btn ghost" type="button">Create your first note</button>
        </div>
      </aside>

      <section class="editor" aria-label="Note editor">
        <div id="empty-editor" class="empty">
          <p>Select a note from the list or create a new one.</p>
        </div>
        <div id="editor-wrap" class="editor-wrap hidden">
          <div class="editor-toolbar">
            <button id="delete-note" class="btn danger outline" type="button" aria-label="Delete note">
              Delete
            </button>
          </div>
          <input
            id="note-title"
            class="title-input"
            type="text"
            placeholder="Note title"
            aria-label="Note title"
            autocomplete="off"
          />
          <textarea
            id="note-body"
            class="body-input"
            placeholder="Write your note…"
            aria-label="Note body"
          ></textarea>
          <div class="meta">
            <span id="meta-updated" aria-live="polite"></span>
            <span id="autosave-indicator" class="fade">Saved</span>
          </div>
        </div>
      </section>
    </section>
  </main>
</Layout>

<style>
  .app {
    min-height: 100dvh;
    display: flex;
    flex-direction: column;
  }
  .topbar {
    position: sticky;
    top: 0;
    z-index: 20;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    padding: 12px 16px;
    background:
      radial-gradient(1200px 120px at 10% -20%, rgba(37,99,235,0.10) 0%, transparent 70%) ,
      var(--bg-color);
    border-bottom: 1px solid var(--border-color);
    backdrop-filter: blur(8px);
  }
  .brand { display: flex; align-items: center; gap: 10px; }
  .brand .logo {
    width: 28px; height: 28px; display: grid; place-items: center;
    border-radius: 8px;
    color: #fff;
    background: linear-gradient(135deg, #2563EB, #1D4ED8);
    box-shadow: 0 6px 14px rgba(37,99,235,0.35), inset 0 -2px 0 rgba(0,0,0,0.15);
  }
  .brand .title { font-size: 18px; margin: 0; letter-spacing: 0.2px; }

  .actions { display: flex; align-items: center; gap: 8px; }

  .content {
    display: grid;
    grid-template-columns: 320px 1fr;
    gap: 0;
    min-height: calc(100dvh - 60px);
  }
  @media (max-width: 920px) {
    .content { grid-template-columns: 1fr; }
    .sidebar { border-right: none; border-bottom: 1px solid var(--border-color); }
  }

  .sidebar {
    display: flex;
    flex-direction: column;
    height: 100%;
    border-right: 1px solid var(--border-color);
    background: var(--card-bg);
  }
  .sidebar-controls {
    display: flex; align-items: center; gap: 8px;
    padding: 12px; border-bottom: 1px solid var(--border-color);
  }
  .search-wrap {
    position: relative; flex: 1;
  }
  .search-wrap input {
    width: 100%;
    padding: 10px 28px 10px 34px;
    border-radius: 10px;
    border: 1px solid var(--border-color);
    background: var(--bg-color);
    color: var(--text-color);
    outline: none;
    transition: border-color .2s, box-shadow .2s, background .2s;
    box-shadow: 0 1px 2px var(--shadow-color);
  }
  .search-wrap input:focus {
    border-color: rgba(37,99,235,.5);
    box-shadow: 0 0 0 4px rgba(37,99,235,.12);
    background: linear-gradient(180deg, rgba(37,99,235,0.06), transparent 40%) , var(--bg-color);
  }
  .search-icon {
    position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: #6b7280;
  }
  .sort {
    display: inline-flex; align-items: center; gap: 6px; font-size: 12px; color: var(--text-secondary);
  }
  .sort select {
    padding: 8px 10px; border-radius: 10px; border: 1px solid var(--border-color); background: var(--bg-color); color: var(--text-color);
  }

  .notes {
    list-style: none; margin: 0; padding: 8px; overflow: auto; height: 100%;
  }
  .notes-item {
    display: grid; grid-template-columns: 1fr auto; gap: 4px 8px;
    padding: 10px 12px; border-radius: 12px;
    border: 1px solid transparent;
    transition: background .2s, transform .06s, border-color .2s, box-shadow .2s;
    cursor: pointer;
  }
  .notes-item:hover { background: rgba(37,99,235,0.06); }
  .notes-item[aria-current="true"] {
    background: linear-gradient(130deg, rgba(37,99,235,0.12), rgba(245,158,11,0.08));
    border-color: rgba(37,99,235,0.35);
    box-shadow: 0 4px 10px rgba(37,99,235,0.15);
  }
  .item-title { font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .item-preview { grid-column: 1 / -1; font-size: 12px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .item-updated { font-size: 12px; color: var(--text-secondary); }

  .editor {
    position: relative; display: flex; flex-direction: column; min-height: 0; background: var(--bg-color);
  }
  .editor-wrap {
    display: grid; grid-template-rows: auto auto 1fr auto; gap: 10px;
    height: 100%; padding: 16px; max-width: 1200px; width: 100%; margin: 0 auto;
  }
  .editor-toolbar {
    display: flex; align-items: center; justify-content: flex-end; gap: 8px;
  }
  .title-input {
    width: 100%; border: 1px solid transparent; background: transparent; color: var(--text-color);
    font-size: 22px; font-weight: 700; padding: 10px 6px; border-radius: 8px; outline: none;
    transition: background .2s, border-color .2s, box-shadow .2s;
  }
  .title-input:focus {
    background: var(--card-bg); border-color: rgba(37,99,235,.45);
    box-shadow: 0 0 0 4px rgba(37,99,235,.12);
  }
  .body-input {
    width: 100%; height: 50vh; min-height: 240px; resize: vertical;
    padding: 12px; border-radius: 12px; border: 1px solid var(--border-color);
    background: var(--card-bg); color: var(--text-color);
    line-height: 1.55; font-size: 15px;
    transition: border-color .2s, box-shadow .2s, background .2s;
    box-shadow: 0 2px 8px var(--shadow-color);
  }
  .body-input:focus { border-color: rgba(37,99,235,.45); box-shadow: 0 0 0 4px rgba(37,99,235,.12); outline: none; }
  .meta { display: flex; align-items: center; justify-content: space-between; font-size: 12px; color: var(--text-secondary); padding: 2px 4px; }
  .fade { opacity: 0; transition: opacity .2s; }
  .fade.show { opacity: 1; }

  .empty {
    display: grid; place-items: center; padding: 24px; color: var(--text-secondary);
  }
  .hidden { display: none; }

  .btn {
    border: 1px solid var(--border-color);
    background: var(--surface, var(--card-bg));
    color: var(--text-color);
    padding: 8px 12px;
    border-radius: 10px;
    cursor: pointer;
    transition: transform .06s ease, box-shadow .2s, background .2s, border-color .2s, color .2s;
    box-shadow: 0 1px 2px var(--shadow-color);
  }
  .btn:hover { transform: translateY(-1px); box-shadow: 0 3px 10px var(--shadow-hover-color); }
  .btn:active { transform: translateY(0); }
  .btn.primary {
    border-color: rgba(37,99,235,.6);
    color: #fff;
    background: linear-gradient(135deg, #2563EB, #1D4ED8);
    box-shadow: 0 6px 14px rgba(37,99,235,0.35), inset 0 -2px 0 rgba(0,0,0,0.15);
  }
  .btn.ghost { background: transparent; }
  .btn.danger {
    color: #fff;
    background: linear-gradient(135deg, #EF4444, #DC2626);
    border-color: rgba(239,68,68,.7);
    box-shadow: 0 6px 14px rgba(239,68,68,0.35), inset 0 -2px 0 rgba(0,0,0,0.15);
  }
  .btn.danger.outline {
    background: transparent; color: #EF4444; border-color: rgba(239,68,68,.6);
    box-shadow: none;
  }
</style>

<script>
  // PUBLIC_INTERFACE
  function formatDateTime(ts) {
    /** Returns a human-friendly date string for a timestamp. */
    const d = new Date(ts);
    return d.toLocaleString(undefined, {
      year: 'numeric', month: 'short', day: '2-digit',
      hour: '2-digit', minute: '2-digit'
    });
  }

  // PUBLIC_INTERFACE
  function loadNotes() {
    /** Load notes array from localStorage under notes.v1 */
    try {
      const raw = localStorage.getItem('notes.v1');
      if (!raw) return [];
      const parsed = JSON.parse(raw);
      if (!Array.isArray(parsed)) return [];
      return parsed;
    } catch {
      return [];
    }
  }

  // PUBLIC_INTERFACE
  function saveNotes(notes) {
    /** Persist notes array to localStorage under notes.v1 */
    localStorage.setItem('notes.v1', JSON.stringify(notes));
  }

  function uid() {
    return Math.random().toString(36).slice(2) + Date.now().toString(36);
  }

  // Debounce helper
  function debounce(fn, delay = 300) {
    let t;
    return (...args) => {
      clearTimeout(t);
      t = setTimeout(() => fn(...args), delay);
    };
  }

  // App state
  let state = {
    notes: [],
    filtered: [],
    selectedId: null,
    sort: 'updated_desc',
    query: ''
  };

  // Elements
  let listEl, emptyListEl, emptyEditorEl, editorWrapEl, titleEl, bodyEl, metaUpdatedEl, autosaveEl;

  function selectNote(id) {
    state.selectedId = id;
    renderList();
    renderEditor();
  }

  // CRUD operations
  // PUBLIC_INTERFACE
  function createNote() {
    /** Create a new note with default values and select it. */
    const now = Date.now();
    const n = { id: uid(), title: 'Untitled', body: '', createdAt: now, updatedAt: now };
    state.notes.unshift(n);
    persistAndRefresh(() => selectNote(n.id));
  }

  // PUBLIC_INTERFACE
  function deleteNote(id) {
    /** Delete a note by ID after confirming with the user. */
    const note = state.notes.find(n => n.id === id);
    if (!note) return;
    const ok = confirm(`Delete note "${note.title || 'Untitled'}"? This cannot be undone.`);
    if (!ok) return;
    state.notes = state.notes.filter(n => n.id !== id);
    if (state.selectedId === id) state.selectedId = null;
    persistAndRefresh();
  }

  function updateNotePartial(id, patch) {
    const idx = state.notes.findIndex(n => n.id === id);
    if (idx === -1) return;
    const updated = { ...state.notes[idx], ...patch, updatedAt: Date.now() };
    state.notes[idx] = updated;
    persistAndRefresh(() => {
      // keep selection
      state.selectedId = updated.id;
    }, { silentList: true });
  }

  function persistAndRefresh(after, opts = {}) {
    saveNotes(state.notes);
    filterAndSort();
    renderList(opts.silentList);
    renderEditor();
    if (after) after();
  }

  function filterAndSort() {
    const q = state.query.trim().toLowerCase();
    let rows = [...state.notes];
    if (q) {
      rows = rows.filter(n =>
        (n.title || '').toLowerCase().includes(q) ||
        (n.body || '').toLowerCase().includes(q)
      );
    }
    if (state.sort === 'updated_desc') {
      rows.sort((a,b) => b.updatedAt - a.updatedAt);
    } else if (state.sort === 'title_asc') {
      rows.sort((a,b) => (a.title || '').localeCompare(b.title || ''));
    }
    state.filtered = rows;
  }

  function renderList(silent = false) {
    if (!listEl) return;
    listEl.setAttribute('aria-busy', 'true');
    listEl.innerHTML = '';
    const rows = state.filtered;
    if (rows.length === 0) {
      emptyListEl.classList.remove('hidden');
    } else {
      emptyListEl.classList.add('hidden');
    }
    rows.forEach(n => {
      const li = document.createElement('li');
      li.className = 'notes-item';
      li.role = 'button';
      li.tabIndex = 0;
      li.setAttribute('aria-current', state.selectedId === n.id ? 'true' : 'false');
      li.addEventListener('click', () => selectNote(n.id));
      li.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); selectNote(n.id); }
      });

      const title = document.createElement('div');
      title.className = 'item-title';
      title.textContent = n.title || 'Untitled';

      const updated = document.createElement('div');
      updated.className = 'item-updated';
      updated.textContent = formatDateTime(n.updatedAt);

      const preview = document.createElement('div');
      preview.className = 'item-preview';
      const bodyPreview = (n.body || '').replace(/\s+/g, ' ').slice(0, 120);
      preview.textContent = bodyPreview;

      li.appendChild(title);
      li.appendChild(updated);
      li.appendChild(preview);
      listEl.appendChild(li);
    });
    listEl.setAttribute('aria-busy', 'false');
    if (!silent) {
      // focus selected item for accessibility
      const current = listEl.querySelector('[aria-current="true"]');
      if (current) current.focus({ preventScroll: true });
    }
  }

  function renderEditor() {
    const note = state.notes.find(n => n.id === state.selectedId);
    if (!note) {
      editorWrapEl.classList.add('hidden');
      emptyEditorEl.classList.remove('hidden');
      return;
    }
    emptyEditorEl.classList.add('hidden');
    editorWrapEl.classList.remove('hidden');
    titleEl.value = note.title || '';
    bodyEl.value = note.body || '';
    metaUpdatedEl.textContent = `Last updated: ${formatDateTime(note.updatedAt)}`;
  }

  // autosave
  const debouncedSaveTitle = debounce((val) => {
    if (!state.selectedId) return;
    updateNotePartial(state.selectedId, { title: val });
    showSaved();
  }, 300);

  const debouncedSaveBody = debounce((val) => {
    if (!state.selectedId) return;
    updateNotePartial(state.selectedId, { body: val });
    showSaved();
  }, 400);

  function showSaved() {
    autosaveEl.classList.add('show');
    setTimeout(() => autosaveEl.classList.remove('show'), 800);
  }

  function init() {
    // cache dom
    listEl = document.getElementById('notes-list');
    emptyListEl = document.getElementById('empty-list');
    emptyEditorEl = document.getElementById('empty-editor');
    editorWrapEl = document.getElementById('editor-wrap');
    titleEl = document.getElementById('note-title');
    bodyEl = document.getElementById('note-body');
    metaUpdatedEl = document.getElementById('meta-updated');
    autosaveEl = document.getElementById('autosave-indicator');

    // load
    state.notes = loadNotes();
    filterAndSort();
    renderList();
    renderEditor();

    // handlers
    document.getElementById('new-note').addEventListener('click', createNote);
    document.getElementById('empty-create').addEventListener('click', createNote);
    document.getElementById('delete-note').addEventListener('click', () => {
      if (!state.selectedId) return;
      deleteNote(state.selectedId);
    });

    const searchEl = document.getElementById('search');
    searchEl.addEventListener('input', debounce((e) => {
      state.query = e.target.value;
      filterAndSort();
      renderList();
    }, 150));

    const sortEl = document.getElementById('sort');
    sortEl.addEventListener('change', (e) => {
      state.sort = e.target.value;
      filterAndSort();
      renderList();
    });

    titleEl.addEventListener('input', (e) => debouncedSaveTitle(e.target.value));
    bodyEl.addEventListener('input', (e) => debouncedSaveBody(e.target.value));

    // If there are no notes, show empty states; otherwise select the most recent
    if (state.notes.length > 0) {
      state.selectedId = state.filtered[0]?.id || state.notes[0].id;
      renderList();
      renderEditor();
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
</script>
